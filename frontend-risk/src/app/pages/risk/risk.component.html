<div class="flex min-h-[70vh] items-center justify-center">
  <div class="w-full max-w-3xl rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-slate-50 shadow-xl shadow-emerald-500/10">
    <div class="flex items-center justify-between gap-3">
      <div>
        <p class="text-xs uppercase text-emerald-300 font-semibold mb-1">AI Risk Flow</p>
        <h1 class="text-2xl font-bold">Sessioned Q&A</h1>
        <p class="text-sm text-slate-400">Start a flow, answer questions, see your risk signals.</p>
      </div>
      <button
        type="button"
        class="rounded-md border border-slate-700 px-3 py-2 text-xs font-semibold text-slate-100 hover:border-emerald-400"
        (click)="restart()"
      >
        Restart flow
      </button>
    </div>

    <ng-container *ngIf="state$ | async as state">
      <div class="mt-4 flex items-center gap-3 text-xs text-slate-400">
        <span class="rounded-full bg-slate-800 px-3 py-1">
          Session: {{ state.sessionId || '—' }}
        </span>
        <span class="rounded-full bg-slate-800 px-3 py-1">
          Answered: {{ state.answeredQuestionIds.length }}{{ state.totalQuestions ? ' / ' + state.totalQuestions : '' }}
        </span>
        <span class="rounded-full bg-slate-800 px-3 py-1" *ngIf="state.isComplete">Complete</span>
      </div>

      <p class="mt-3 text-xs text-rose-400" *ngIf="state.error">{{ state.error }}</p>

      <div class="mt-6 space-y-4" *ngIf="!state.isComplete; else resultTpl">
        <div
          *ngIf="state.currentQuestion; else waitingQuestion"
          class="space-y-3 rounded-xl border border-slate-800 bg-slate-900/60 p-5"
        >
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-emerald-300 font-semibold">Question</p>
              <p class="text-sm text-slate-400">
                {{ state.answeredQuestionIds.length + 1 }}{{ state.totalQuestions ? ' of ' + state.totalQuestions : '' }}
              </p>
            </div>
            <span class="rounded-full bg-slate-800 px-3 py-1 text-xs font-semibold text-emerald-200">
              {{ state.currentQuestion.type }}
            </span>
          </div>

          <div class="space-y-2">
            <p class="text-base font-semibold text-slate-100">
              {{ state.currentQuestion.text || state.currentQuestion.label || 'Question' }}
            </p>
            <p class="text-sm text-slate-400" *ngIf="state.currentQuestion.placeholder">
              {{ state.currentQuestion.placeholder }}
            </p>
          </div>

          <div [ngSwitch]="state.currentQuestion.type">
            <select
              *ngSwitchCase="QuestionType.SINGLE_CHOICE"
              class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none"
              [(ngModel)]="answer"
            >
              <option value="">Select an option</option>
              <option *ngFor="let opt of state.currentQuestion.options" [value]="opt.value">{{ opt.label }}</option>
            </select>

            <div *ngSwitchCase="'select'" class="space-y-2">
              <select
                class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none"
                [(ngModel)]="answer"
              >
                <option value="">Select an option</option>
                <option *ngFor="let opt of state.currentQuestion.options" [value]="opt.value">{{ opt.label }}</option>
              </select>
            </div>

            <div *ngSwitchCase="QuestionType.MULTI_CHOICE" class="space-y-2">
              <label
                class="flex items-center gap-2 rounded-md border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-200 hover:border-emerald-400"
                *ngFor="let opt of state.currentQuestion.options"
              >
                <input
                  type="checkbox"
                  [value]="opt.value"
                  [checked]="isMultiSelected(opt.value)"
                  (change)="toggleMulti(opt.value, $any($event.target).checked)"
                  class="h-4 w-4 accent-emerald-400"
                />
                {{ opt.label }}
              </label>
            </div>

            <div *ngSwitchCase="'multi-select'" class="space-y-2">
              <label
                class="flex items-center gap-2 rounded-md border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-200 hover:border-emerald-400"
                *ngFor="let opt of state.currentQuestion.options"
              >
                <input
                  type="checkbox"
                  [value]="opt.value"
                  [checked]="isMultiSelected(opt.value)"
                  (change)="toggleMulti(opt.value, $any($event.target).checked)"
                  class="h-4 w-4 accent-emerald-400"
                />
                {{ opt.label }}
              </label>
            </div>

            <div *ngSwitchCase="QuestionType.BOOLEAN" class="flex gap-3">
              <button
                type="button"
                class="rounded-lg border px-3 py-2 text-sm font-semibold"
                [class.border-emerald-500]="answer === true"
                (click)="setBoolean(true)"
              >
                Yes
              </button>
              <button
                type="button"
                class="rounded-lg border px-3 py-2 text-sm font-semibold"
                [class.border-emerald-500]="answer === false"
                (click)="setBoolean(false)"
              >
                No
              </button>
            </div>

            <div *ngSwitchCase="'boolean'" class="flex gap-3">
              <button
                type="button"
                class="rounded-lg border px-3 py-2 text-sm font-semibold"
                [class.border-emerald-500]="answer === true"
                (click)="setBoolean(true)"
              >
                Yes
              </button>
              <button
                type="button"
                class="rounded-lg border px-3 py-2 text-sm font-semibold"
                [class.border-emerald-500]="answer === false"
                (click)="setBoolean(false)"
              >
                No
              </button>
            </div>

            <div *ngSwitchCase="QuestionType.SCALE" class="space-y-2">
              <input
                type="range"
                class="w-full accent-emerald-400"
                [min]="state.currentQuestion.min || 0"
                [max]="state.currentQuestion.max || 10"
                [(ngModel)]="answer"
              />
              <div class="text-sm text-emerald-200">Selected: {{ answer }}</div>
            </div>

            <div *ngSwitchCase="'scale'" class="space-y-2">
              <input
                type="range"
                class="w-full accent-emerald-400"
                [min]="state.currentQuestion.min || 0"
                [max]="state.currentQuestion.max || 10"
                [(ngModel)]="answer"
              />
              <div class="text-sm text-emerald-200">Selected: {{ answer }}</div>
            </div>

            <textarea
              *ngSwitchDefault
              [(ngModel)]="answer"
              rows="4"
              class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none"
              placeholder="Type your answer..."
            ></textarea>
          </div>

          <div class="flex flex-wrap gap-3">
            <button
              type="button"
              class="rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-900 shadow hover:bg-emerald-400 disabled:opacity-60"
              (click)="submitAnswer(state)"
              [disabled]="!canSubmit(state)"
            >
              {{ state.loadingAnswer ? 'Submitting...' : 'Submit answer' }}
            </button>
            <button
              type="button"
              class="rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-100 hover:border-emerald-400 disabled:opacity-60"
              (click)="skipQuestion(state)"
              [disabled]="state.loadingAnswer || state.loadingEvaluate"
            >
              Skip
            </button>
          </div>
        </div>

        <ng-template #waitingQuestion>
          <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 text-sm text-slate-300">
            {{ state.loadingStart ? 'Starting flow...' : 'Waiting for the first question...' }}
          </div>
        </ng-template>
      </div>

      <ng-template #resultTpl>
        <div class="space-y-4 rounded-xl border border-slate-800 bg-slate-900/60 p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-emerald-300 font-semibold">Final evaluation</p>
              <p class="text-sm text-slate-400">Complete the flow to see your score and signals.</p>
            </div>
            <span
              class="rounded-full px-3 py-1 text-xs font-semibold"
              [ngClass]="{
                'bg-emerald-900/60 text-emerald-200': state.finalResult?.riskLevel === RiskLevel.LOW,
                'bg-amber-900/60 text-amber-200': state.finalResult?.riskLevel === RiskLevel.MEDIUM,
                'bg-rose-900/60 text-rose-200': state.finalResult?.riskLevel === RiskLevel.HIGH
              }"
            >
              {{ state.finalResult?.riskLevel || '—' }}
            </span>
          </div>

          <ng-container *ngIf="state.finalResult; else waitingEvaluation">
            <div class="grid gap-3 md:grid-cols-3">
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-4">
                <p class="text-xs uppercase text-slate-400">Final score</p>
                <p class="text-4xl font-bold text-emerald-300">{{ state.finalResult.finalScore }}</p>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-4">
                <p class="text-xs uppercase text-slate-400">Confidence</p>
                <p class="text-4xl font-bold text-slate-50">{{ state.finalResult.finalConfidence }}%</p>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-4">
                <p class="text-xs uppercase text-slate-400">Risk level</p>
                <p class="text-2xl font-semibold text-slate-100">{{ state.finalResult.riskLevel }}</p>
              </div>
            </div>

            <div *ngIf="state.finalResult.signals?.length" class="space-y-2">
              <p class="text-xs uppercase text-slate-400">Signals</p>
              <div class="grid gap-3 md:grid-cols-2">
                <div
                  *ngFor="let signal of state.finalResult.signals"
                  class="rounded-lg border border-slate-800 bg-slate-950/70 p-3"
                >
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold text-slate-100">{{ signal.label }}</p>
                    <span class="text-xs text-emerald-300 font-semibold">{{ signal.score }}</span>
                  </div>
                  <p class="text-xs text-slate-400 mt-1" *ngIf="signal.description">{{ signal.description }}</p>
                  <p class="text-xs text-slate-400 mt-1" *ngIf="signal.confidence !== undefined">
                    Confidence: {{ signal.confidence }}%
                  </p>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-template #waitingEvaluation>
            <div class="space-y-3">
              <p class="text-sm text-slate-300">
                {{ state.loadingEvaluate ? 'Finalizing evaluation...' : 'Evaluation not yet run.' }}
              </p>
              <button
                type="button"
                class="rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-900 shadow hover:bg-emerald-400 disabled:opacity-60"
                (click)="evaluate(state)"
                [disabled]="state.loadingEvaluate"
              >
                {{ state.loadingEvaluate ? 'Evaluating...' : 'Run evaluation' }}
              </button>
            </div>
          </ng-template>
        </div>
      </ng-template>
    </ng-container>
  </div>
</div>

